name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./src/Automais.Api

    - name: Build
      run: dotnet build --configuration Release --no-restore
      working-directory: ./src/Automais.Api

    - name: Publish
      run: dotnet publish --configuration Release --no-build --output ./publish
      working-directory: ./src/Automais.Api

    - name: Create deployment package
      run: |
        cd src/Automais.Api/publish
        tar -czf ../../../deploy.tar.gz .
        cd ../../..

    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        debug: true
        source: "deploy.tar.gz"
        target: "/root/automais.io/server.io/"

    - name: Copy systemd service file
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        debug: true
        source: "deploy/automais-api.service"
        target: "/tmp/"

    - name: Deploy on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        debug: true
        script: |
          # Verificar se arquivo de serviço foi copiado
          if [ ! -f /tmp/automais-api.service ]; then
            echo "ERRO: Arquivo automais-api.service não encontrado em /tmp/"
            exit 1
          fi
          
          # Copiar arquivo de serviço para systemd
          cp /tmp/automais-api.service /etc/systemd/system/automais-api.service
          chmod 644 /etc/systemd/system/automais-api.service
          
          # Recarregar systemd
          systemctl daemon-reload
          
          # Ir para diretório da aplicação
          cd /root/automais.io/server.io
          
          # Extrair arquivos
          tar -xzf deploy.tar.gz
          rm deploy.tar.gz
          
          # Criar diretório de backups se não existir
          mkdir -p /backups/routers
          
          # Habilitar serviço (se ainda não estiver habilitado)
          systemctl enable automais-api.service || true
          
          # Reiniciar serviço
          systemctl restart automais-api.service
          
          # Aguardar um pouco e verificar status
          sleep 2
          systemctl status automais-api.service

