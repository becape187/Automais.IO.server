name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore
      working-directory: ./src/Automais.Api

    - name: Build
      run: dotnet build --configuration Release --no-restore
      working-directory: ./src/Automais.Api

    - name: Publish
      run: dotnet publish --configuration Release --no-build --output ./publish
      working-directory: ./src/Automais.Api

    - name: Create deployment package
      run: |
        cd src/Automais.Api/publish
        tar -czf ../../../deploy.tar.gz .
        cd ../../..

    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        debug: true
        source: "deploy.tar.gz"
        target: "/root/automais.io/server.io/"

    - name: Deploy on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        debug: true
        script: |
          echo "=== Iniciando deploy ==="
          
          # Ir para diretório da aplicação
          cd /root/automais.io/server.io
          
          echo "Extraindo arquivos da aplicação..."
          tar -xzf deploy.tar.gz
          rm deploy.tar.gz
          
          # Criar diretório de backups se não existir
          mkdir -p /backups/routers
          
          echo "Verificando serviço systemd..."
          if systemctl list-unit-files | grep -q automais-api.service; then
            echo "✓ Serviço encontrado"
            
            # Verificar se está habilitado
            if systemctl is-enabled automais-api.service >/dev/null 2>&1; then
              echo "✓ Serviço está habilitado"
            else
              echo "Habilitando serviço..."
              systemctl enable automais-api.service || echo "Aviso: Erro ao habilitar"
            fi
            
            # Recarregar systemd (caso o arquivo tenha sido atualizado manualmente)
            systemctl daemon-reload
            
            echo "Reiniciando serviço..."
            systemctl restart automais-api.service
            
            # Aguardar um pouco e verificar status
            sleep 3
            echo "Status do serviço:"
            systemctl status automais-api.service --no-pager || true
          else
            echo "⚠️  Serviço automais-api.service não encontrado"
            echo "Certifique-se de que o serviço foi criado manualmente em /etc/systemd/system/automais-api.service"
            exit 1
          fi
          
          echo "=== Deploy concluído ==="

